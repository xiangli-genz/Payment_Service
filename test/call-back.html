<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test ZaloPay Callback</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 25px;
    }

    .section h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .info-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      margin-bottom: 15px;
    }

    .info-box p {
      margin: 8px 0;
      line-height: 1.6;
    }

    .info-box code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .alert-warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }

    .alert-success {
      background: #d1fae5;
      border-left: 4px solid #10b981;
      color: #065f46;
    }

    .alert-info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      color: #1e40af;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      font-family: 'Courier New', monospace;
    }

    .form-group textarea {
      min-height: 150px;
      resize: vertical;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .response-box {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
    }

    .steps {
      counter-reset: step-counter;
      list-style: none;
    }

    .steps li {
      counter-increment: step-counter;
      margin-bottom: 20px;
      padding-left: 50px;
      position: relative;
    }

    .steps li::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 35px;
      height: 35px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85em;
    }

    .copy-btn:hover {
      background: #5568d3;
    }

    pre {
      position: relative;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß™ Test ZaloPay Callback</h1>
      <p>C√¥ng c·ª• test callback t·ª´ ZaloPay sandbox</p>
    </div>

    <!-- Instructions -->
    <div class="card">
      <div class="section">
        <h3>üìã H∆∞·ªõng D·∫´n Test Callback</h3>
        
        <div class="alert alert-warning">
          <strong>‚ö†Ô∏è Quan tr·ªçng:</strong> Callback URL ph·∫£i l√† domain c√¥ng khai (https). Kh√¥ng th·ªÉ test v·ªõi localhost!
        </div>

        <ol class="steps">
          <li>
            <strong>C√†i ƒë·∫∑t ngrok:</strong><br>
            <code>npm install -g ngrok</code> ho·∫∑c t·∫£i t·ª´ <a href="https://ngrok.com" target="_blank">ngrok.com</a>
          </li>
          <li>
            <strong>Ch·∫°y Payment Service:</strong><br>
            <code>cd payment-service && npm run dev</code> (Port 3003)
          </li>
          <li>
            <strong>T·∫°o ngrok tunnel:</strong><br>
            <code>ngrok http 3003</code><br>
            Copy URL d·∫°ng: <code>https://abc-xyz.ngrok-free.dev</code>
          </li>
          <li>
            <strong>C·∫≠p nh·∫≠t .env:</strong><br>
            <code>ZALOPAY_CALLBACK_URL=https://your-ngrok-url.ngrok-free.dev/api/payments/callback</code>
          </li>
          <li>
            <strong>Test thanh to√°n:</strong><br>
            M·ªü <code>test/payment-test.html</code> ‚Üí Ch·ªçn ZaloPay ‚Üí Thanh to√°n
          </li>
        </ol>
      </div>
    </div>

    <!-- Callback URL Check -->
    <div class="card">
      <div class="section">
        <h3>üîó Ki·ªÉm Tra Callback URL</h3>
        
        <div class="form-group">
          <label>Callback URL hi·ªán t·∫°i:</label>
          <input type="text" id="callbackUrl" placeholder="https://your-domain.ngrok-free.dev/api/payments/callback/zalopay">
        </div>

        <button class="btn btn-primary" onclick="testCallbackUrl()">
          Ki·ªÉm Tra URL
        </button>

        <div id="urlCheckResult" style="margin-top: 15px;"></div>
      </div>
    </div>

    <!-- Simulate Callback -->
    <div class="card">
      <div class="section">
        <h3>üîß Gi·∫£ L·∫≠p Callback (Local Test)</h3>
        
        <div class="alert alert-info">
          D√πng ƒë·ªÉ test callback handler m√† kh√¥ng c·∫ßn thanh to√°n th·∫≠t
        </div>

        <div class="form-group">
          <label>Payment Code:</label>
          <input type="text" id="paymentCode" placeholder="PAYL..." value="">
        </div>

        <div class="form-group">
          <label>Callback Data (JSON):</label>
          <textarea id="callbackData">{
  "app_id": 2554,
  "app_trans_id": "240111_123456",
  "app_user": "PAYL...",
  "amount": 350000,
  "app_time": 1736582400000,
  "embed_data": "{}",
  "item": "[]",
  "zp_trans_id": "240111000001234",
  "server_time": 1736582401000,
  "channel": 1,
  "merchant_user_id": "",
  "user_fee_amount": 0,
  "discount_amount": 0
}</textarea>
        </div>

        <button class="btn btn-primary" onclick="simulateCallback()">
          G·ª≠i Callback Gi·∫£ L·∫≠p
        </button>

        <div id="simulateResult" style="margin-top: 15px;"></div>
      </div>
    </div>

    <!-- Check Payment Status -->
    <div class="card">
      <div class="section">
        <h3>üîç Ki·ªÉm Tra Tr·∫°ng Th√°i Payment</h3>
        
        <div class="form-group">
          <label>Payment Code:</label>
          <input type="text" id="checkPaymentCode" placeholder="PAYL...">
        </div>

        <button class="btn btn-primary" onclick="checkPaymentStatus()">
          Ki·ªÉm Tra
        </button>

        <div id="paymentStatusResult" style="margin-top: 15px;"></div>
      </div>
    </div>

    <!-- Logs -->
    <div class="card">
      <div class="section">
        <h3>üìú Server Logs</h3>
        <div class="alert alert-info">
          Theo d√µi logs trong terminal c·ªßa Payment Service ƒë·ªÉ debug callback
        </div>
        <pre><code>npm run dev

# Khi c√≥ callback, b·∫°n s·∫Ω th·∫•y:
=== ZALOPAY CALLBACK RECEIVED ===
Body: { data: "...", mac: "..." }
‚úÖ Signature verified successfully
üì¶ Callback Data: { ... }
üìÑ Found Payment: { paymentCode: "...", ... }
‚úÖ Payment marked as COMPLETED
‚úÖ Updated booking payment status</code></pre>
      </div>
    </div>
  </div>

  <script>
    const serviceUrl = 'http://localhost:3003';

    async function testCallbackUrl() {
      const url = document.getElementById('callbackUrl').value;
      const resultDiv = document.getElementById('urlCheckResult');
      
      if (!url) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Vui l√≤ng nh·∫≠p URL!</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="alert alert-info">‚è≥ ƒêang ki·ªÉm tra...</div>';

      try {
        const response = await fetch(url, {
          method: 'GET'
        });

        if (response.ok || response.status === 404) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              ‚úÖ URL c√≥ th·ªÉ truy c·∫≠p ƒë∆∞·ª£c!<br>
              Status: ${response.status}<br>
              <small>B√¢y gi·ªù b·∫°n c√≥ th·ªÉ d√πng URL n√†y l√†m callback URL cho ZaloPay</small>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-warning">
              ‚ö†Ô∏è URL tr·∫£ v·ªÅ status ${response.status}<br>
              C√≥ th·ªÉ v·∫´n ho·∫°t ƒë·ªông v·ªõi POST request
            </div>
          `;
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            ‚ùå Kh√¥ng th·ªÉ truy c·∫≠p URL<br>
            L·ªói: ${error.message}<br>
            <small>ƒê·∫£m b·∫£o ngrok ƒëang ch·∫°y v√† URL ƒë√∫ng</small>
          </div>
        `;
      }
    }

    async function simulateCallback() {
      const paymentCode = document.getElementById('paymentCode').value;
      const callbackDataStr = document.getElementById('callbackData').value;
      const resultDiv = document.getElementById('simulateResult');

      if (!paymentCode) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Vui l√≤ng nh·∫≠p Payment Code!</div>';
        return;
      }

      try {
        const callbackData = JSON.parse(callbackDataStr);
        callbackData.app_user = paymentCode;

        // T·∫°o MAC gi·∫£ l·∫≠p
        const dataStr = JSON.stringify(callbackData);
        
        // G·ª≠i callback
        resultDiv.innerHTML = '<div class="alert alert-info">‚è≥ ƒêang g·ª≠i callback...</div>';

        const response = await fetch(`${serviceUrl}/api/payments/callback/zalopay`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            data: dataStr,
            mac: 'simulated_mac_for_testing'
          })
        });

        const result = await response.json();

        resultDiv.innerHTML = `
          <div class="alert ${result.return_code === 1 ? 'alert-success' : 'alert-warning'}">
            <strong>Response:</strong><br>
            Return Code: ${result.return_code}<br>
            Message: ${result.return_message}
          </div>
          <div class="response-box">${JSON.stringify(result, null, 2)}</div>
        `;

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            ‚ùå L·ªói: ${error.message}
          </div>
        `;
      }
    }

    async function checkPaymentStatus() {
      const paymentCode = document.getElementById('checkPaymentCode').value;
      const resultDiv = document.getElementById('paymentStatusResult');

      if (!paymentCode) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Vui l√≤ng nh·∫≠p Payment Code!</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="alert alert-info">‚è≥ ƒêang ki·ªÉm tra...</div>';

      try {
        // T√¨m payment theo code (c·∫ßn t·∫°o endpoint n√†y n·∫øu ch∆∞a c√≥)
        const response = await fetch(`${serviceUrl}/api/payments/code/${paymentCode}`);
        
        if (response.ok) {
          const data = await response.json();
          const payment = data.data.payment;

          let statusBadge = '';
          if (payment.status === 'completed') {
            statusBadge = '‚úÖ Completed';
          } else if (payment.status === 'pending') {
            statusBadge = '‚è≥ Pending';
          } else if (payment.status === 'failed') {
            statusBadge = '‚ùå Failed';
          }

          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <strong>Payment: ${payment.paymentCode}</strong><br>
              Status: <strong>${statusBadge}</strong><br>
              Amount: ${payment.amount.toLocaleString()}ƒë<br>
              Method: ${payment.method}<br>
              ${payment.transactionId ? `Transaction ID: ${payment.transactionId}<br>` : ''}
              ${payment.paidAt ? `Paid At: ${new Date(payment.paidAt).toLocaleString('vi-VN')}` : ''}
            </div>
            <div class="response-box">${JSON.stringify(payment, null, 2)}</div>
          `;
        } else {
          resultDiv.innerHTML = '<div class="alert alert-warning">‚ùå Payment kh√¥ng t·ªìn t·∫°i</div>';
        }

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning">
            ‚ùå L·ªói: ${error.message}
          </div>
        `;
      }
    }
  </script>
</body>
</html>